name: Sign and Notarize App

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag for release to sign"
        required: true

jobs:
  notarize-mac:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # üîç Auto-detect and select latest Xcode installed on the GitHub runner
      - name: Select latest Xcode
        run: |
          LATEST_XCODE=$(ls -1 /Applications | grep "Xcode_" | sort -V | tail -n 1)
          if [ -z "$LATEST_XCODE" ]; then
            echo "‚ö†Ô∏è No specific Xcode version found, falling back to default"
            sudo xcode-select -s /Applications/Xcode.app
          else
            echo "‚úÖ Selecting $LATEST_XCODE"
            sudo xcode-select -s "/Applications/$LATEST_XCODE"
          fi
          xcode-select -p

      # üîë Import Apple signing certificate (from GitHub secrets)
      - name: Import Code-Signing Certificates
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.MAC_CERTIFICATE }}
          p12-password: ${{ secrets.MAC_CERTIFICATE_PASSWORD }}

      # üì¶ Build your unsigned app (replace with your actual build step)
      - name: Build App
        run: |
          npm install
          npm run build

      # ‚úçÔ∏è Sign the app
      - name: Code Sign App
        run: |
          codesign --deep --force --options runtime \
          --entitlements entitlements.mac.plist \
          --sign "Developer ID Application: Marika Basagoitia (R9ZPUC7AGS)" \
          "unsigned-build/dist/demo/mac-arm64/Yale Philharmonia Library Catalogue-demo.app"

      # üì® Notarize using Apple API Key
      - name: Notarize App
        uses: GuillaumeFalourd/notary-tools@v1
        with:
          product-path: unsigned-build/dist/demo/mac-arm64/Yale Philharmonia Library Catalogue-demo.app
          apple-id: ${{ secrets.APPLE_ID }}
          password: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          team-id: R9ZPUC7AGS

      # ‚úÖ Staple notarization ticket
      - name: Staple Notarization
        run: |
          xcrun stapler staple "unsigned-build/dist/demo/mac-arm64/Yale Philharmonia Library Catalogue-demo.app"
          spctl --assess --type exec -v "unsigned-build/dist/demo/mac-arm64/Yale Philharmonia Library Catalogue-demo.app"
