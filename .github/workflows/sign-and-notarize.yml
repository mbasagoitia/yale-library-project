name: Build, Sign, and Notarize App

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag for release to sign"
        required: true

jobs:
  build-sign-notarize:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Build Electron app
        run: npm run build:demo

      - name: Import code signing certificates
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.CERT_P12_BASE64 }}
          p12-password: ${{ secrets.CERT_P12_PASSWORD }}

      - name: Zip .app for notarization
        run: |
          cd unsigned-build/dist/demo/mac-arm64
          ditto -c -k --keepParent "Yale Philharmonia Library Catalogue-demo.app" "YalePhilharmonia.zip"
          ls -lh

      - name: Notarize app with Apple
        run: |
          xcrun notarytool submit "unsigned-build/dist/demo/mac-arm64/YalePhilharmonia.zip" \
            --apple-id "${{ secrets.APPLE_ID }}" \
            --team-id "${{ secrets.APPLE_TEAM_ID }}" \
            --password "${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}" \
            --wait

      - name: Staple notarization ticket
        run: |
          xcrun stapler staple "unsigned-build/dist/demo/mac-arm64/Yale Philharmonia Library Catalogue-demo.app"
          spctl --assess --type exec -v "unsigned-build/dist/demo/mac-arm64/Yale Philharmonia Library Catalogue-demo.app"

      - name: Upload notarized app artifact
        uses: actions/upload-artifact@v4
        with:
          name: notarized-app
          path: unsigned-build/dist/demo/mac-arm64/Yale Philharmonia Library Catalogue-demo.app
